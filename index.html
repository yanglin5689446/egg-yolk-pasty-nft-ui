<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="shortcut icon" type="image/icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="192x192" href="/images/192x192_App_Icon.png" />
  <link rel="apple-touch-icon" sizes="512x512" href="/images/512x512_App_Icon.png" />

  <link rel="stylesheet" href="./main.css" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#1336bf" />
  <link rel="preload" href="https://fonts.googleapis.com/css?family=Work+Sans:400,500,600&display=swap" as="style"
    onload="this.onload=null;this.rel='stylesheet'" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.5.3-rc.0/web3.min.js" integrity="sha512-+18yqikfKtcOi8TjTjfcOdQsu8XaBg0JIJlZkhcsegIFgCGbQzAoTR1AeutQBNraEf8qCrSpua2EMugVWO+utA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.15.4/css/fontawesome.css" crossorigin="anonymous"/>
  <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.15.4/css/brands.css" crossorigin="anonymous"/>
  <title>虛擬蛋黃酥.jpg</title>
  <script>
    const CONTRACT_ADDRESS = "0xafd4e6ce929e1358b65bdb217f818c2052f237a5"
    const CONTRACT_ABI = [{"inputs":[{"internalType":"string","name":"_baseURI","type":"string"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256[]","name":"ids","type":"uint256[]"},{"indexed":false,"internalType":"uint256[]","name":"values","type":"uint256[]"}],"name":"TransferBatch","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"TransferSingle","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"value","type":"string"},{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"}],"name":"URI","type":"event"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"id","type":"uint256"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address[]","name":"accounts","type":"address[]"},{"internalType":"uint256[]","name":"ids","type":"uint256[]"}],"name":"balanceOfBatch","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"mint","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"number","type":"uint256"}],"name":"mintMultiple","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"price","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256[]","name":"ids","type":"uint256[]"},{"internalType":"uint256[]","name":"amounts","type":"uint256[]"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"safeBatchTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"id","type":"uint256"}],"name":"uri","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}]
    const CHAIN_ID = 4
    const web3 = new Web3(window.ethereum)
    const contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS)
    let account = null

    async function initialize() {
      if(account) return ;

      if(!window.ethereum) {
        document.getElementById('connect-wallet').innerText = "請使用 Metamask"
        return
      }
      [account] = await window.ethereum.enable()
      if (account) {
        document.getElementById('connect-wallet').innerText = account.slice(0, 6) + "......" + account.slice(-6)
      }

      const chainId = await web3.eth.getChainId()
      if(chainId !== CHAIN_ID) {
        document.getElementById('connect-wallet').innerText = "請使用 Matic 網路"
        return
      }
    }

    async function mint() {
      const result = await contract.methods.mint().send({
        from: account,
        value: 149000000000000000,
      })

      const newlyMinted = result.events.TransferSingle.returnValues.id
      const tokenURI = await contract.methods.uri(newlyMinted).call()
      const image = await fetch(tokenURI)
        .then(response => response.json())
        .then(json => json.image)
      document.getElementById("preview").src = image
    }

    async function mint10() {
      const result = await contract.methods.mintMultiple(10).send({
        from: account,
        value: 1490000000000000000,
      })
      const newlyMinted = result.events.TransferSingle.map(item => item.returnValues.id)
      const tokenURIs = await Promise.all(newlyMinted.map(id => contract.methods.uri(id).call()))

      const images = await Promise.all(
        tokenURIs.map(tokenURI => fetch(tokenURI)
          .then(response => response.json())
          .then(json => json.image)
        ))
      document.getElementById("preview").src = images[0]
    }

  </script>
</head>
<body>
  <div class="fluid-container main">
    <div class="header d-flex flex-row justify-content-end">
      <button id="connect-wallet" class="btn btn-secondary account me-4" onClick="initialize()">連接錢包</button>
    </div>
    <div>
      <div class="d-flex justify-content-center">
        <img id="preview" src="https://placeimg.com/300/300" />
      </div>
      <div class="d-flex justify-content-center flex-column flex-md-row my-3">
        <button class="btn btn-primary my-2 mx-3 d-block d-md-inline-block" type="button" onclick="mint()">1 個月餅</button>
        <button class="btn btn-primary my-2 mx-3 d-block d-md-inline-block" type="button" onclick="mint10()">10(+1) 個月餅</button>
      </div>
    </div>
    <footer class="py-5">
      <h5 class="text-center">Social Links</h5>
      <div class="d-flex justify-content-center">
        <i class="fab fa-discord"></i>
      </div>
    </footer>
  </div>
  <script>
    initialize();
  </script>
</body>
</html>